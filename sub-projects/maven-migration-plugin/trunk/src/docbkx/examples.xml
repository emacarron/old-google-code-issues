<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN" "http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">
<!--
    Copyright 2010 The myBatis Team

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->

<!--
    version: $Id$
-->
<chapter id="examples">
    <title>Examples</title>

    <section id="examples.lyfecycle">
        <title>Intregrate migrate in Maven life cycle</title>
        <para>
            It can be useful integrate Migration steps into a build life cycle, i.e. integrating the database schema
            creation into a CI build lifecycle.

            <programlisting language="xml"><![CDATA[...
<plugins>
    <plugin>
        <groupId>]]><?eval ${project.groupId}?><![CDATA[</groupId>
        <artifactId>]]><?eval ${project.artifactId}?><![CDATA[</artifactId>
        <version>]]><?eval ${project.version}?><![CDATA[</version>
        <dependencies>
            [ add your jdbc driver depencency ]
        </dependencies>
        <executions>
          <execution>
            <id>apply-all-pending-migration</id>
            <phase>process-test-resources</phase>
            <goals>
                <goal>up</goal>
            </goals>
            <configuration>
                 <repository> [migration repository path] </repository>
            </configuration>
          </execution>
       </executions>
    </plugin>
  ...
<plugins>]]></programlisting>

            If your project uses the sub-modules you can set your parent pom in this way:

            <programlisting language="xml"><![CDATA[...
<build>
    <pluginManagement>
        <plugins>
            <plugin>
                <groupId>]]><?eval ${project.groupId}?><![CDATA[</groupId>
                <artifactId>]]><?eval ${project.artifactId}?><![CDATA[</artifactId>
                <version>]]><?eval ${project.version}?><![CDATA[</version>
                <dependencies>
                    [ add your jdbc driver depencency ]
                </dependencies>
                <configuration>
                    <skip>true</skip>
                </configuration>
            </plugin>
        </plugins>
    </pluginManagement>

    <plugins>
        <plugin>
            <groupId>]]><?eval ${project.groupId}?><![CDATA[</groupId>
            <artifactId>]]><?eval ${project.artifactId}?><![CDATA[</artifactId>
        </plugin>
    </plugins>
</build>]]></programlisting>

            Then, in submodules:

            <programlisting language="xml"><![CDATA[...
<plugins>
    <plugin>
        <groupId>]]><?eval ${project.groupId}?><![CDATA[</groupId>
        <artifactId>]]><?eval ${project.artifactId}?><![CDATA[</artifactId>
        <configuration>
            <repository> [migration repository path] </repository>
            <skip>false</skip>
        </configuration>
        <executions>
            <execution>
                <id>migration-chack</id>
                <phase>test</phase>
                <goals>
                    <goal>check</goal>
                </goals>
                <inherited>false</inherited>
            </execution>
        </executions>
    </plugin>
  ...
<plugins>]]></programlisting>
        </para>
    </section>

    <section id="examples.commands">
        <title>Use Migration commands</title>
        <para>
            Migration plugin aims to help you to administer your database via MyBatis Schema Migration, so, i.e, you can
            use this plugin to create new migration scripts and to apply the pending scripts to your database.
            The following example will show the common commands to create and administer your database.
        </para>
        <para>
            First of all you have to initialize your migration repository:

            <screen><![CDATA[mvn migration:init -Dmigration.path=/path/to/repository]]></screen>

            This command inizializes the standard migration repository into <literal>/path/to/repository</literal> folder.

            After you have to modify and customize your enviroment: edit the file
            <literal>/path/to/repository/enviroments/development.properties</literal> and set the database coordinte.
            So you can apply the first migration to the database:

            <screen><![CDATA[mvn migration:up -Dmigration.path=/path/to/repository]]></screen>

            Now it is possible to create the new script:

            <screen><![CDATA[mvn migration:new -Dmigration.path=/path/to/repository -Dmigration.description=my_second_schema_migration]]></screen>

            the command creates a new empty sql file into the folder <literal>/path/to/repository/scripts</literal>
            like this:

            <screen><![CDATA[--// First migration.
-- Migration SQL that makes the change goes here.

--//@UNDO
-- SQL to undo the change goes here.]]></screen>

            now you can check the current status of your database by executing this the status goal:

            <screen><![CDATA[mvn migration:status -Dmigration.path=/path/to/repository

[INFO] Executing  Apache Migration StatusCommand
[INFO] ID             Applied At             Description
[INFO] ================================================================================
[INFO] 20100400000001    2010-04-24 22:51:16    create changelog
[INFO] 20100400000002    2010-04-24 22:51:17    first migration
[INFO] 20100400000003    ...pending...          my second schema migration
[INFO]]]></screen>

            finally you can apply the last migration pending script:

            <screen><![CDATA[mvn migration:up -Dmigration.path=/path/to/repository

mvn migration:status -Dmigration.path=/path/to/repository

[INFO] Executing  Apache Migration StatusCommand
[INFO] ID             Applied At             Description
[INFO] ================================================================================
[INFO] 20100400000001    2010-04-24 22:51:16    create changelog
[INFO] 20100400000002    2010-04-24 22:51:17    first migration
[INFO] 20100400000003    2010-04-24 23:14:07    my second schema migration
[INFO]]]></screen>
        </para>
    </section>

    <section id="examples.report">
        <title>Migration plugin report</title>
        <para>
            <mediaobject>
                <imageobject role="fo">
                    <imagedata fileref="src/docbkx/graphics/migration-mvn.png" format="PNG" />
                </imageobject>
            </mediaobject>
        </para>
    </section>

    <section id="examples.warnreport">
        <title>Migration plugin report with warnings</title>
        <para>
            <mediaobject>
                <imageobject role="fo">
                    <imagedata fileref="src/docbkx/graphics/migration-mvn-warning.png" format="PNG" />
                </imageobject>
            </mediaobject>
        </para>
    </section>

</chapter>
